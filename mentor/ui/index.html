<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Mentora - Learn, Grow, and Achieve</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            flex-shrink: 0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .header-title-container {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            justify-content: center;
        }

        .header-title-container .logo {
            width: 40px;
            height: 40px;
        }

        header h1 {
            font-size: 2.2rem;
            font-weight: 600;
        }
        
        #logged-in-user-container {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: rgba(255, 255, 255, 0.15);
            padding: 6px 12px;
            border-radius: 20px;
            width: 200px;
            justify-content: flex-end;
        }
        #logged-in-user-container span {
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #logged-in-user {
            font-weight: bold;
            color: #ffffff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }


        .footer {
            text-align: center;
            padding: 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            flex-shrink: 0;
            font-size: 0.9rem;
        }

        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
            width: 100%;
            padding: 20px;
            gap: 20px;
        }

        .sidebar {
            width: 280px;
            min-width: 250px;
            background-color: #ffffff;
            padding: 1.5rem;
            border-radius: 15px;
            overflow-y: auto;
            flex-shrink: 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .sidebar h4 {
            margin-top: 0;
            margin-bottom: 0.75rem;
            color: #4a5568;
            font-size: 1.1rem;
            font-weight: 600;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 8px;
        }

        #past-sessions {
            list-style: none;
            padding-left: 0;
            margin-top: 1rem;
            margin-bottom: 0;
        }

        #past-sessions li {
            background: #f8f9fa;
            margin-bottom: 0.75rem;
            padding: 0.8rem 1rem;
            border-radius: 10px;
            cursor: pointer;
            border-left: 4px solid transparent;
            transition: all 0.3s ease;
        }

        #past-sessions li:hover {
            transform: translateX(5px);
            background: #e9ecef;
            border-left: 4px solid #667eea;
        }

        .session-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 0.2rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .session-meta {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 0.3rem;
        }

        .session-snippet {
            font-size: 0.85rem;
            color: #495057;
            max-height: 2.8em;
            line-height: 1.4em;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .main-content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: #f8f9fa99;
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .message {
            max-width: 80%;
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message.assistant {
            align-self: flex-start;
        }

        .message-icon {
            flex-shrink: 0;
            width: 38px;
            height: 38px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .message.user .message-icon {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }

        .message.assistant .message-icon {
            background-color: #96c2f0;
        }

        .message-icon svg {
            width: 22px;
            height: 22px;
        }
        .message.user .message-icon svg {
            fill: white;
        }
        .message.assistant .message-icon svg {
            fill: #343a40;
        }

        .message-bubble {
            padding: 12px 18px;
            position: relative;
            word-wrap: break-word;
            white-space: pre-wrap;
            line-height: 1.0;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 18px 18px 4px 18px;
        }

        .message.assistant .message-bubble {
            background-color: #b4caf652;
            color: #343a40;
            border-radius: 18px 18px 18px 4px;
        }
        
        .message.assistant .message-bubble ul {
            padding-left: 20px;
            margin-top: 5px;
            margin-bottom: 5px;
        }
        .message.assistant .message-bubble li {
            margin-bottom: 2px;
        }
        .message.assistant .message-bubble p {
            margin-bottom: 0.5em;
        }
        .message.assistant .message-bubble p:last-child {
            margin-bottom: 0;
        }
        
        .mentor-icon::before {
            content: none;
        }

        .message-bubble-footer {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-top: 8px;
        }

        .message time {
            font-size: 0.75rem;
            color: #adb5bd;
            user-select: none;
        }
        .message.user time {
            color: #e0e0e0;
        }

        .input-box {
            display: flex;
            padding: 1rem 1.5rem;
            background-color: #ffffff;
            border-top: 1px solid #dee2e6;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        .input-box textarea {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #dee2e6;
            border-radius: 20px;
            font-size: 1rem;
            resize: none;
            min-height: 48px;
            max-height: 150px;
            overflow-y: auto;
            font-family: inherit;
            transition: border-color 0.3s ease;
        }
        .input-box textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .hidden {
            display: none !important;
        }

        .form-group {
            margin-bottom: 25px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
            font-size: 1rem;
        }

        select, input[type="text"], input[type="password"] {
            width: 100%;
            padding: 12px;
            font-size: 1rem;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            font-family: inherit;
            transition: border-color 0.3s ease;
        }
        select:focus, input[type="text"]:focus, input[type="password"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        .btn-primary:disabled {
            background: #b3b9e8;
            cursor: not-allowed;
        }

        #send-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        #send-btn:hover:not(:disabled) {
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.5);
            transform: translateY(-1px);
        }
        #send-btn:disabled {
            background: #b3b9e8;
            cursor: not-allowed;
        }
        #send-btn svg {
            width: 24px;
            height: 24px;
            fill: white;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }


        .btn-secondary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: transparent;}
        .btn-secondary:hover:not(:disabled) {
            background: #cbd5e0;
        }

        .login {
            max-width: 450px;
            margin: auto;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }
        .login h2 {
            text-align: center;
            margin-bottom: 15px;
            color: #4a5568;
            font-size: 1.8rem;
        }

        .setup {
            padding: 40px;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            overflow-y: auto;
        }
        .setup-content {
            max-width: 500px;
            width: 100%;
        }
        .setup h2 {
            color: #4a5568;
            margin-bottom: 30px;
            font-size: 1.8rem;
        }

        .setup .form-group {
            text-align: left;
        }
        
        #typing-indicator {
            font-style: italic;
            color: #666;
            margin: 0 1.5rem 0.5rem;
            height: 1.5rem;
            user-select: none;
            text-align: left;
            padding-left: 5px;
        }

        .skill-tag {
            background: #e9ecef;
            color: #495057;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
            font-size: 0.95rem;
            font-weight: 500;
            white-space: nowrap;
        }
        .skill-tag:hover {
            border-color: #bdc5e8;
        }

        .skill-tag.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        #selected-skills-display {
            border: 2px solid #e2e8f0;
            padding: 10px;
            min-height: 48px;
            border-radius: 8px;
            background-color: #fff;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            margin-top: 10px;
        }
        .selected-skill-item {
            background-color: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        .selected-skill-item .remove-skill {
            background: none;
            border: 1px solid white;
            color: white;
            font-weight: bold;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            font-size: 0.8em;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 16px;
            width: 16px;
            border-radius: 50%;
        }

        #custom-skill-input-container {
            margin-top: 10px;
        }
        #custom-skill-input-container button {
            padding: 12px 18px;
            font-size: 0.9rem;
        }

        .suggestion-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #ffffff;
            border-radius: 10px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 0.85rem;
            border:transparent;
            transition: background-color 0.3s ease;
        }
        .suggestion-btn:hover {
            background-color: #cbd5e0;
        }
        #suggestion-buttons-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 0 1.5rem 1rem;
        }

        /* --- Voice button Icon Styling --- */
        #voice-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        #voice-btn:hover:not(:disabled) {
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.5);
            transform: translateY(-1px);
        }
        #voice-btn svg {
            width: 24px;
            height: 24px;
            fill: white;
        }
        #voice-btn.listening {
            background: #e53e3e; /* Red background when listening */
            animation: pulse-red 1.5s infinite;
        }
        #voice-btn.listening svg {
            fill: white;
        }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(229, 62, 62, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(229, 62, 62, 0); }
            100% { box-shadow: 0 0 0 0 rgba(229, 62, 62, 0); }
        }

        /* --- Replay Audio Button on Message --- */
        .replay-audio-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 2px;
            margin-left: 8px;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        .replay-audio-btn:hover {
            opacity: 1;
        }
        .replay-audio-btn svg {
            width: 16px;
            height: 16px;
            fill: #4a5568;
        }
        .message.user .replay-audio-btn {
            display: none; /* Don't show for user messages */
        }
    </style>
</head>
<body>

    <header>
        <div style="width: 200px;"></div> <div class="header-title-container">
            <svg class="logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#a29bfe;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#667eea;stop-opacity:1" />
                    </linearGradient>
                </defs>
                <path fill="url(#logoGradient)" d="M50,5A45,45,0,1,1,5,50,45,45,0,0,1,50,5M50,0a50,50,0,1,0,50,50A50,50,0,0,0,50,0Z"/>
                <path fill="white" d="M50 20 L 30 35 L 50 50 L 70 35 L 50 20 Z M 50 55 L 30 70 L 50 85 L 70 70 L 50 55 Z"/>
            </svg>
            <h1>Mentora</h1>
            <p>Learn, Grow, and Achieve</p>
        </div>
        <div id="logged-in-user-container" class="hidden">
            <span>Logged in as: </span>
            <span id="logged-in-user"></span>
        </div>
    </header>

    <div class="login" id="login-section">
        <h2>Welcome Back!</h2>
        <p style="text-align: center; color: #6c757d; margin-bottom: 25px; font-size: 1rem;">
            Your personalized AI-powered mentor to help you master any skills. Learn, Grow, and Achieve with interactive sessions tailored to your needs.
        </p>
        <div class="form-group">
            <label for="userId">User ID:</label>
            <input type="text" id="userId" />
        </div>
        <div class="form-group">
            <label for="password">Password:</label>
            <input type="password" id="password" />
        </div>
        <button id="login-btn" class="btn btn-primary" style="width: 100%;" onclick="login()">Login</button>
        <p id="login-error" style="color: #e53e3e; margin-top: 15px; text-align: center;"></p>
    </div>

    <div class="container hidden" id="main-app-container">
        <div class="sidebar">
            <button onclick="showSetupSection()" class="btn btn-secondary" style="margin-bottom: 1rem; width: 100%;">New Session</button>
            <h4>Previous Sessions</h4>
            <ul id="past-sessions" title="Click to load session"></ul>
        </div>

        <div class="main-content-area" id="dynamic-content-area">
            <div class="setup" id="setup-section">
                <div class="setup-content">
                    <h2>Personalize Your Learning Journey</h2>
                    <div class="form-group">
                        <label for="Choose_Your_Persona">Choose Your Persona:</label>
                        <select id="role">
                            <option value="Techno_Functional">Techno Functional</option>
                            <option value="Executive">Executive</option>
                            <option value="Technical">Technical</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="difficulty">Choose Your Level:</label>
                        <select id="difficulty">
                            <option value="Beginner">Beginner</option>
                            <option value="Intermediate">Intermediate</option>
                            <option value="Advanced">Advanced</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Skills:</label>
                        <div id="skills-selection-container" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;">
                            <span class="skill-tag predefined" data-skill="Gen AI">Gen AI</span>
                            <span class="skill-tag predefined" data-skill="Python">Python</span>
                            <span class="skill-tag predefined" data-skill="Machine Learning">Machine Learning</span>
                            <span class="skill-tag predefined" data-skill="JAVA">JAVA</span>
                            <span class="skill-tag predefined" data-skill="Agentic AI">Agentic AI</span>
                            <span class="skill-tag predefined" data-skill="Others" id="others-skill-tag">Others</span>
                        </div>
                        <div id="custom-skill-input-container" class="hidden" style="display: flex; gap: 5px;">
                            <input type="text" id="custom-skill-input" placeholder="Type custom skill" style="flex: 1;"/>
                            <button type="button" class="btn btn-primary" onclick="addCustomSkill()">Add</button>
                        </div>
                        <div id="selected-skills-display">
                            <span id="no-skills-selected" style="color: #999; font-size: 0.9rem;">Click skills above to add</span>
                        </div>
                        <input type="hidden" id="selected-skills-hidden-input" name="selected_skills" value="" />
                    </div>
                    
                    
                    <button onclick="startSession()" class="btn btn-primary" style="width: 100%;">Start Learning</button>
                </div>
            </div>

            <div class="chat-area hidden" id="chat-messages-area">
                <div class="messages" id="chat-messages"></div>
                <div id="suggestion-buttons-container"></div>
                <div id="typing-indicator" class="hidden">Mentora is thinking...</div>
                <div class="input-box">
                    <textarea id="user-input" placeholder="Ask your Mentora..." rows="1"></textarea>
                    <!-- Voice Input Button -->
                    <button id="voice-btn" title="Use Voice Input">
                        <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.49 6-3.31 6-6.72h-1.7z"></path></svg>
                    </button>
                    <button id="send-btn" onclick="sendMessage()">
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        Powered by HCLTech 2025
    </div>

    <script>
        let chatHistory = [];
        let userId = "";
        let currentChatTitle = null;
        let isQuizMode = false;
        let quizState = {};
        const loginBtn = document.getElementById('login-btn');
        const sendBtn = document.getElementById('send-btn');
        const typingIndicator = document.getElementById('typing-indicator');
        const mainAppContainer = document.getElementById('main-app-container');
        const setupSection = document.getElementById('setup-section');
        const chatMessagesArea = document.getElementById('chat-messages-area');
        const chatMessagesDiv = document.getElementById('chat-messages');
        const skillsSelectionContainer = document.getElementById('skills-selection-container');
        const othersSkillTag = document.getElementById('others-skill-tag');
        const customSkillInputContainer = document.getElementById('custom-skill-input-container');
        const customSkillInput = document.getElementById('custom-skill-input');
        const selectedSkillsDisplay = document.getElementById('selected-skills-display');
        const noSkillsSelectedSpan = document.getElementById('no-skills-selected');
        const selectedSkillsHiddenInput = document.getElementById('selected-skills-hidden-input');
        const loggedInUserContainer = document.getElementById('logged-in-user-container');
        let currentSelectedSkills = new Set();
        const API_BASE_URL = 'http://127.0.0.1:8085';
        
        // --- Initialize Markdown Converter ---
        const converter = new showdown.Converter();

        // --- SVG Icons ---
        const sendIconSVG = `<svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>`;
        const loadingSpinnerHTML = `<div class="loading-spinner"></div>`;
        const replayIconSVG = `<svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></svg>`;

        // --- Web Speech API Setup ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const SpeechSynthesis = window.speechSynthesis;
        const voiceBtn = document.getElementById('voice-btn');
        const userInput = document.getElementById('user-input');
        let recognition;
        let isListening = false;
        let currentlyPlayingUtterance = null;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            voiceBtn.addEventListener('click', () => {
                if (isListening) {
                    recognition.stop();
                } else {
                    recognition.start();
                }
            });

            recognition.onstart = () => {
                isListening = true;
                voiceBtn.classList.add('listening');
                voiceBtn.title = "Stop Listening";
            };

            recognition.onend = () => {
                isListening = false;
                voiceBtn.classList.remove('listening');
                voiceBtn.title = "Use Voice Input";
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                userInput.value = transcript;
                userInput.style.height = 'auto';
                userInput.style.height = (userInput.scrollHeight) + 'px';
            };

            recognition.onerror = (event) => {
                console.error("Speech recognition error:", event.error);
                alert(`Speech recognition error: ${event.error}`);
            };
        } else {
            voiceBtn.style.display = 'none';
            console.warn("Web Speech API for recognition not supported in this browser.");
        }

        function speak(text, onEndCallback) {
            if (SpeechSynthesis && text) {
                if (SpeechSynthesis.speaking) {
                    SpeechSynthesis.cancel();
                }
                const utterance = new SpeechSynthesisUtterance(text);
                currentlyPlayingUtterance = utterance;
                utterance.onend = () => {
                    currentlyPlayingUtterance = null;
                    if (onEndCallback) {
                        onEndCallback();
                    }
                };
                utterance.onerror = (event) => {
                    console.error("SpeechSynthesis Error", event);
                    currentlyPlayingUtterance = null;
                };
                SpeechSynthesis.speak(utterance);
            }
        }

        function toggleSpeak(text, btnElement) {
            if (SpeechSynthesis.speaking && currentlyPlayingUtterance && currentlyPlayingUtterance.text === text) {
                SpeechSynthesis.cancel(); 
            } else {
                document.querySelectorAll('.replay-audio-btn.speaking').forEach(b => b.classList.remove('speaking'));
                
                speak(text, () => {
                    btnElement.classList.remove('speaking');
                });
                btnElement.classList.add('speaking');
            }
        }
        
        function setSendButtonToSend() {
            sendBtn.innerHTML = sendIconSVG;
            sendBtn.disabled = false;
        }

        function setSendButtonToLoading() {
            sendBtn.innerHTML = loadingSpinnerHTML;
            sendBtn.disabled = true;
        }

        userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        userInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        skillsSelectionContainer.addEventListener('click', (event) => {
            const target = event.target;
            if (target.classList.contains('skill-tag') && target.dataset.skill) {
                const skill = target.dataset.skill;
                if (skill === "Others") {
                    if (customSkillInputContainer.classList.contains('hidden')) {
                        customSkillInputContainer.classList.remove('hidden');
                        target.classList.add('selected');
                        if (!currentSelectedSkills.has("Others")) {
                            currentSelectedSkills.add("Others");
                            updateSelectedSkillsDisplay();
                        }
                        customSkillInput.focus();
                    } else {
                        customSkillInputContainer.classList.add('hidden');
                        target.classList.remove('selected');
                        currentSelectedSkills.delete("Others");
                        updateSelectedSkillsDisplay();
                    }
                } else {
                    if (currentSelectedSkills.has(skill)) {
                        currentSelectedSkills.delete(skill);
                        target.classList.remove('selected');
                    } else {
                        currentSelectedSkills.add(skill);
                        target.classList.add('selected');
                    }
                    updateSelectedSkillsDisplay();
                }
            }
        });

        function addCustomSkill() {
            const skill = customSkillInput.value.trim();
            if (skill && !currentSelectedSkills.has(skill)) {
                currentSelectedSkills.add(skill);
                updateSelectedSkillsDisplay();
                customSkillInput.value = "";
                customSkillInput.focus();
            } else if (currentSelectedSkills.has(skill)) {
                alert(`"${skill}" is already added.`);
            }
        }

        function removeSkill(skillToRemove) {
            currentSelectedSkills.delete(skillToRemove);
            if (skillToRemove === "Others") {
                othersSkillTag.classList.remove('selected');
                customSkillInputContainer.classList.add('hidden');
            }
            document.querySelectorAll('.skill-tag.predefined').forEach(tag => {
                if (tag.dataset.skill === skillToRemove) {
                    tag.classList.remove('selected');
                }
            });
            updateSelectedSkillsDisplay();
        }

        function updateSelectedSkillsDisplay() {
            selectedSkillsDisplay.innerHTML = '';
            if (currentSelectedSkills.size === 0) {
                selectedSkillsDisplay.appendChild(noSkillsSelectedSpan);
                noSkillsSelectedSpan.classList.remove('hidden');
            } else {
                noSkillsSelectedSpan.classList.add('hidden');
                currentSelectedSkills.forEach(skill => {
                    const skillItem = document.createElement('span');
                    skillItem.className = 'selected-skill-item';
                    skillItem.textContent = skill;
                    const removeButton = document.createElement('button');
                    removeButton.className = 'remove-skill';
                    removeButton.textContent = 'x';
                    removeButton.onclick = () => removeSkill(skill);
                    skillItem.appendChild(removeButton);
                    selectedSkillsDisplay.appendChild(skillItem);
                });
            }
            selectedSkillsHiddenInput.value = JSON.stringify(Array.from(currentSelectedSkills));
        }

        document.addEventListener('DOMContentLoaded', () => {
             updateSelectedSkillsDisplay();
             setSendButtonToSend();
        });

        async function login() {
            userId = document.getElementById("userId").value.trim();
            const password = document.getElementById("password").value;
            const errorElem = document.getElementById("login-error");
            errorElem.textContent = "";
            if (!userId || !password) {
                errorElem.textContent = "Please enter User ID and Password.";
                return;
            }
            loginBtn.disabled = true;
            loginBtn.textContent = "Logging in...";
            try {
                const res = await fetch(`${API_BASE_URL}/login`, {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({user_id: userId, password})
                });
                if (res.ok) {
                    document.getElementById("login-section").classList.add("hidden");
                    mainAppContainer.classList.remove("hidden");
                    loggedInUserContainer.classList.remove("hidden");
                    showSetupSection();
                    document.getElementById("logged-in-user").textContent = userId;
                    await fetchChats();
                } else {
                    errorElem.textContent = "Login failed. Check credentials.";
                }
            } catch(e) {
                errorElem.textContent = "Error connecting to server.";
                console.error("Login error:", e);
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = "Login";
            }
        }

        function showSetupSection() {
            setupSection.classList.remove("hidden");
            chatMessagesArea.classList.add("hidden");
            chatHistory = [];
            currentChatTitle = null;
            isQuizMode = false;
            quizState = {};
            renderMessages();
        }

        // async function fetchChats() {
        //     try {
        //         const res = await fetch(`${API_BASE_URL}/get_chats?user_id=${encodeURIComponent(userId)}`);
        //         if (!res.ok) throw new Error("Failed to fetch chats. Status: " + res.status);
        //         const data = await res.json();
        //         const list = document.getElementById("past-sessions");
        //         list.innerHTML = "";
        //         if (!data.chats || data.chats.length === 0) {
        //             list.innerHTML = '<li style="font-style: italic; color: #666;">No previous sessions</li>';
        //             return;
        //         }
        //         data.chats.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        //         data.chats.forEach(chat => {
        //             const li = document.createElement("li");
        //             li.title = chat.title;
        //             li.onclick = () => loadChat(chat.title);
        //             li.innerHTML = `
        //                 <div class="session-title">${chat.title.replace(/_\d{8,}_\w{4}$/, '').replace(/_/g, ' ')}</div>
        //                 <div class="session-meta">${new Date(chat.created_at).toLocaleString()}</div>
        //             `;
        //             list.appendChild(li);
        //         });
        //     } catch (e) {
        //         console.error("Error fetching chats:", e);
        //         document.getElementById("past-sessions").innerHTML = '<li style="color: red; font-style: italic;">Error loading sessions.</li>';
        //     }
        // }

        async function fetchChats() {
            try {
                const res = await fetch(`${API_BASE_URL}/get_chats?user_id=${encodeURIComponent(userId)}`);
                if (!res.ok) throw new Error("Failed to fetch chats. Status: " + res.status);
                const data = await res.json();
                const list = document.getElementById("past-sessions");
                list.innerHTML = "";
                if (!data.chats || data.chats.length === 0) {
                    const li = document.createElement("li");
                    li.textContent = "No previous sessions";
                    li.style.fontStyle = "italic";
                    li.style.color = "#666";
                    list.appendChild(li);
                    return;
                }
                data.chats.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                
                data.chats.forEach(chat => {
                    const chatTitle = chat.title;
                    const chatCreatedAt = chat.created_at;

                    const li = document.createElement("li");
                    li.title = chatTitle;
                    li.onclick = () => loadChat(chatTitle);

                    const titleDiv = document.createElement("div");
                    titleDiv.className = "session-title";
                    titleDiv.textContent = chatTitle.replace(/_\d{8,}_\w{4}$/, '').replace(/_/g, ' ');

                    const metaDiv = document.createElement("div");
                    metaDiv.className = "session-meta";
                    const dt = chatCreatedAt ? new Date(chatCreatedAt) : new Date();
                    metaDiv.textContent = dt.toLocaleString();

                    // Create the snippet div and fetch content for it
                    const snippetDiv = document.createElement("div");
                    snippetDiv.className = "session-snippet";
                    snippetDiv.textContent = "Loading preview..."; 

                    fetch(`${API_BASE_URL}/get_chat_messages?user_id=${encodeURIComponent(userId)}&title=${encodeURIComponent(chatTitle)}`)
                        .then(res => res.json())
                        .then(data => {
                            if (data.messages && data.messages.length > 0) {
                                const firstAssistant = data.messages.find(m => m.role === "assistant");
                                if (firstAssistant && firstAssistant.content) {
                                    snippetDiv.textContent = firstAssistant.content.split('\n')[0].slice(0, 60) + "...";
                                } else {
                                   snippetDiv.textContent = "No preview available.";
                                }
                            }
                        }).catch(() => {
                             snippetDiv.textContent = "Could not load preview.";
                        });

                    li.appendChild(titleDiv);
                    li.appendChild(metaDiv);
                    li.appendChild(snippetDiv); // Add the snippet div back
                    list.appendChild(li);
                });
            } catch (e) {
                console.error("Error fetching chats:", e);
                const list = document.getElementById("past-sessions");
                list.innerHTML = '<li style="color: red; font-style: italic;">Error loading sessions.</li>';
            }
        }

        async function loadChat(title) {
            try {
                const res = await fetch(`${API_BASE_URL}/get_chat_messages?user_id=${encodeURIComponent(userId)}&title=${encodeURIComponent(title)}`);
                if (!res.ok) throw new Error("Failed to load chat messages.");
                const data = await res.json();
                chatHistory = data.messages || [];
                quizState = data.state?.quiz_state || {};
                isQuizMode = quizState.is_active || false;
                
                currentChatTitle = title;
                renderMessages();
                setupSection.classList.add("hidden");
                chatMessagesArea.classList.remove("hidden");
            } catch (e) {
                console.error("Error loading chat:", e);
                alert("Failed to load chat: " + title);
            }
        }

        async function startSession() {
            const skills = Array.from(currentSelectedSkills);
            if (skills.length === 0) {
                alert("Please select at least one skill.");
                return;
            }
            const startBtn = document.querySelector('.setup button');
            startBtn.disabled = true;
            startBtn.textContent = "Starting...";
            try {
                const res = await fetch(`${API_BASE_URL}/start_session`, {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        user_id: userId,
                        skills,
                        difficulty: document.getElementById("difficulty").value,
                        role: document.getElementById("role").value
                    })
                });
                if (!res.ok) throw new Error("Failed to start session.");
                const data = await res.json();

                setupSection.classList.add("hidden");
                chatMessagesArea.classList.remove("hidden");
                currentChatTitle = data.title;
                chatHistory = [];
                isQuizMode = false;
                quizState = {};

                const introMessage = {
                    role: "assistant",
                    content: data.intro_and_topics,
                    timestamp: Date.now() / 1000,
                };

                chatHistory.push(introMessage);
                displayMessage(introMessage);
                showPromptButtons(data.suggestions);
                
                await fetchChats();
            } catch (e) {
                console.error("Error starting session:", e);
                alert("Failed to start session. Check console for details.");
            } finally {
                startBtn.disabled = false;
                startBtn.textContent = "Start Session";
            }
        }

        function renderMessages() {
            chatMessagesDiv.innerHTML = '';
            chatHistory.forEach(displayMessage);
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
        }
        
        function displayMessage(messageObj) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', messageObj.role);

            const iconDiv = document.createElement('div');
            iconDiv.className = 'message-icon';
            iconDiv.innerHTML = messageObj.role === 'user' 
                ? `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>`
                : `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#343a40"><path d="M12 3L1 9l4 2.18v6.32l7 3.51 7-3.51v-6.32L23 9l-11-6zm-7 8.18L12 15l7-3.82L12 7.36 5 11.18zM12 16.5l-4-2v-3.5l4 2 4-2v3.5l-4 2z"/></svg>`;

            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble';
            
            const contentDiv = document.createElement('div');
            contentDiv.innerHTML = converter.makeHtml(messageObj.content);
            bubbleDiv.appendChild(contentDiv);

            const bubbleFooter = document.createElement('div');
            bubbleFooter.className = 'message-bubble-footer';
            const date = messageObj.timestamp ? new Date(messageObj.timestamp * 1000) : new Date();
            bubbleFooter.innerHTML = `<time>${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</time>`;

            if (messageObj.role === 'assistant') {
                const replayBtn = document.createElement('button');
                replayBtn.className = 'replay-audio-btn';
                replayBtn.title = 'Play audio';
                replayBtn.innerHTML = replayIconSVG;
                replayBtn.onclick = () => toggleSpeak(messageObj.content, replayBtn);
                bubbleFooter.appendChild(replayBtn);
            }
            
            bubbleDiv.appendChild(bubbleFooter);
            messageDiv.appendChild(iconDiv);
            messageDiv.appendChild(bubbleDiv);
            chatMessagesDiv.appendChild(messageDiv);
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
        }

        async function sendMessage(messageTextOverride) {
            const messageText = messageTextOverride || userInput.value.trim();
            if (!messageText || !userId || !currentChatTitle) return;

            if (messageText.toLowerCase() === 'quiz me!') {
                userInput.value = '';
                userInput.style.height = 'auto';
                startQuiz();
                return;
            }

            const userMessageObject = { role: "user", content: messageText, timestamp: Date.now() / 1000 };
            displayMessage(userMessageObject);
            chatHistory.push(userMessageObject);
            userInput.value = '';
            userInput.style.height = 'auto';
            
            setSendButtonToLoading();
            typingIndicator.classList.remove('hidden');
            document.getElementById('suggestion-buttons-container').innerHTML = ''; 

            try {
                const response = await fetch(`${API_BASE_URL}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        chat_title: currentChatTitle,
                        chat_history: chatHistory,
                        is_quiz_mode: isQuizMode,
                        quiz_state: quizState
                    })
                });
                const data = await response.json();
                response.ok ? handleBackendResponse(data) : displayMessage({ role: 'assistant', content: `Error: ${data.detail}`, timestamp: Date.now() / 1000 });
            } catch (error) {
                console.error('Error sending message:', error);
                displayMessage({ role: 'assistant', content: 'Failed to get a response. Please try again.', timestamp: Date.now() / 1000 });
            } finally {
                setSendButtonToSend();
                typingIndicator.classList.add('hidden');
            }
        }

        async function startQuiz() {
            const userMessage = { role: 'user', content: 'Quiz me!', timestamp: Date.now() / 1000 };
            displayMessage(userMessage);
            chatHistory.push(userMessage);

            setSendButtonToLoading();
            typingIndicator.classList.remove('hidden');
            document.getElementById('suggestion-buttons-container').innerHTML = ''; 

            try {
                const response = await fetch(`${API_BASE_URL}/start_quiz`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, chat_title: currentChatTitle, chat_history: chatHistory })
                });
                const data = await response.json();
                response.ok ? handleBackendResponse(data) : displayMessage({ role: 'assistant', content: `Error starting quiz: ${data.detail}`, timestamp: Date.now() / 1000 });
            } catch (error) {
                console.error('Error starting quiz:', error);
                displayMessage({ role: 'assistant', content: 'Failed to start the quiz. Please try again.', timestamp: Date.now() / 1000 });
            } finally {
                setSendButtonToSend();
                typingIndicator.classList.add('hidden');
            }
        }

        async function submitQuizAnswer(selectedOption) {
            const userMessage = { role: 'user', content: selectedOption, timestamp: Date.now() / 1000 };
            displayMessage(userMessage);
            chatHistory.push(userMessage);

            setSendButtonToLoading();
            typingIndicator.classList.remove('hidden');
            document.getElementById('suggestion-buttons-container').innerHTML = '';

            try {
                const response = await fetch(`${API_BASE_URL}/quiz_answer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        chat_title: currentChatTitle,
                        chat_history: chatHistory,
                        selected_option: selectedOption,
                        current_question_number: quizState.current_question || 1
                    })
                });
                const data = await response.json();
                response.ok ? handleBackendResponse(data) : displayMessage({ role: 'assistant', content: `Error processing answer: ${data.detail}`, timestamp: Date.now() / 1000 });
            } catch (error) {
                console.error('Error submitting answer:', error);
                displayMessage({ role: 'assistant', content: 'Failed to process your answer. Please try again.', timestamp: Date.now() / 1000 });
            } finally {
                setSendButtonToSend();
                typingIndicator.classList.add('hidden');
            }
        }

        function handleBackendResponse(data) {
            const mentorMessageObject = { role: "assistant", content: data.reply, timestamp: Date.now() / 1000 };
            displayMessage(mentorMessageObject);
            chatHistory.push(mentorMessageObject);
            
            isQuizMode = data.is_quiz_mode || false;
            quizState = data.quiz_state || {};
            
            if (data.suggestions && Array.isArray(data.suggestions)) {
                showPromptButtons(data.suggestions);
            }
        }

        function showPromptButtons(prompts) {
            const container = document.getElementById('suggestion-buttons-container');
            container.innerHTML = '';
            if (!prompts) return;

            prompts.forEach(prompt => {
                const btn = document.createElement('button');
                btn.textContent = prompt;
                btn.className = 'suggestion-btn';
                
                if (isQuizMode && quizState.is_active && /^[A-D]\)/.test(prompt)) {
                     btn.onclick = () => submitQuizAnswer(prompt);
                } else {
                    btn.onclick = () => sendMessage(prompt);
                }
                container.appendChild(btn);
            });
            container.style.display = prompts.length > 0 ? 'flex' : 'none';
        }

    </script>
</body>
</html>