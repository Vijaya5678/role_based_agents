<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Mentor Me</title>
    <style>
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
            background-color: #f4f7fc;
            color: #333;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        header {
            background-color: #004aad;
            color: white;
            padding: 1rem;
            text-align: center;
            flex-shrink: 0;
        }
        .footer {
            text-align: center;
            padding: 1rem;
            background-color: #004aad;
            color: white;
            flex-shrink: 0;
        }
        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        .sidebar {
            width: 280px;
            min-width: 200px;
            background-color: #e8f0fe;
            padding: 1rem;
            border-right: 1px solid #ccc;
            overflow-y: auto;
            flex-shrink: 0;
        }
        .sidebar h3, .sidebar h4 {
            margin-top: 0;
            margin-bottom: 0.5rem;
        }
        #logged-in-user {
            font-weight: bold;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            color: #004aad;
        }
        #past-sessions {
            list-style: none;
            padding-left: 0;
            margin-top: 1rem;
            margin-bottom: 0;
        }
        #past-sessions li {
            background: white;
            margin-bottom: 0.75rem;
            padding: 0.6rem 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0,0,0,0.05);
            transition: background-color 0.2s ease;
        }
        #past-sessions li:hover {
            background-color: #d2e3fc;
        }
        .session-title {
            font-weight: 600;
            color: #004aad;
            margin-bottom: 0.2rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .session-meta {
            font-size: 0.75rem;
            color: #666;
            margin-bottom: 0.3rem;
        }
        .session-snippet {
            font-size: 0.85rem;
            color: #333;
            max-height: 2.8em;
            line-height: 1.4em;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .main-content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            background-color: white;
            display: flex;
            flex-direction: column;
        }
        .message {
            margin: 0.5rem 0;
            padding: 0.75rem;
            border-radius: 8px;
            max-width: 70%;
            position: relative;
            word-wrap: break-word;
            white-space: pre-wrap;
        }
        .message.user {
            background-color: #d2e3fc;
            align-self: flex-end;
        }
        .message.assistant {
            background-color: #ffffff;
            align-self: flex-start;
            border-left: 5px solid #004aad;
            white-space: pre-wrap;
        }
        .mentor-icon::before {
            content: "üë®‚Äçüè´ ";
        }
        .message time {
            display: block;
            font-size: 0.7rem;
            color: #777;
            margin-top: 0.3rem;
            text-align: right;
            user-select: none;
        }
        .input-box {
            display: flex;
            padding: 1rem;
            background-color: #f1f1f1;
            border-top: 1px solid #ccc;
            align-items: center;
            flex-shrink: 0;
        }
        .input-box textarea {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1rem;
            resize: vertical;
            min-height: 40px;
            max-height: 120px;
            overflow-y: auto;
        }
        .input-box button {
            background-color: #004aad;
            color: white;
            padding: 0.75rem 1rem;
            border: none;
            margin-left: 0.5rem;
            border-radius: 5px;
            cursor: pointer;
            min-width: 80px;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }
        .input-box button:disabled {
            background-color: #6699cc;
            cursor: not-allowed;
        }
        .hidden {
            display: none !important;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        select, input[type="text"], input[type="password"], textarea {
            width: 100%;
            padding: 0.5rem;
            font-size: 1rem;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-family: 'Segoe UI', sans-serif;
        }
        button {
            padding: 0.6rem 1rem;
            background-color: #004aad;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }
        button:hover:not(:disabled) {
            background-color: #003580;
        }
        .login {
            max-width: 400px;
            margin: 2rem auto;
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }
        .setup {
            max-width: 600px;
            margin: 2rem auto;
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            width: 90%;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            overflow-y: auto;
            padding-bottom: 2rem;
        }
        .setup .form-group {
            width: 100%;
            max-width: 400px;
            text-align: left;
        }
        .setup button {
            margin-top: 1rem;
        }
        .password-wrapper {
            position: relative;
        }
        .password-wrapper input {
            padding-right: 2.5rem;
        }
        .toggle-password {
            position: absolute;
            top: 50%;
            right: 0.7rem;
            transform: translateY(-50%);
            cursor: pointer;
            font-size: 1.1rem;
            color: #777;
            user-select: none;
        }
        #typing-indicator {
            font-style: italic;
            color: #666;
            margin: 0 1rem 0.5rem 1rem;
            height: 1.5rem;
            user-select: none;
            text-align: center;
        }
        .skill-tag {
            background-color: #e8f0fe;
            color: #004aad;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            border: 1px solid #c2d9ff;
            transition: all 0.2s ease;
            font-size: 0.95rem;
            white-space: nowrap;
        }
        .skill-tag:hover {
            background-color: #d2e3fc;
            border-color: #a8c8ff;
        }
        .skill-tag.selected {
            background-color: #004aad;
            color: white;
            border-color: #003580;
        }
        .selected-skill-item {
            background-color: #0056b3;
            color: white;
            padding: 5px 8px;
            border-radius: 3px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
            white-space: nowrap;
        }
        .selected-skill-item .remove-skill {
            background: none;
            border: none;
            color: white;
            font-weight: bold;
            cursor: pointer;
            padding: 0 3px;
            line-height: 1;
            font-size: 1em;
            margin-left: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 1em;
        }
        #custom-skill-input-container button {
            padding: 0.5rem 0.8rem;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        .suggestion-btn {
            background-color: #e8f0fe;
            color: #004aad;
            border: 1px solid #c2d9ff;
            border-radius: 20px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 1rem;
            margin-right: 8px;
            margin-bottom: 8px;
        }
        .suggestion-btn:hover {
            background-color: #d0e3ff;
        }
        #suggestion-buttons-container {
            display: flex;
            gap: 10px;
            margin: 1rem 1rem 0 1rem;
        }
    </style>
</head>
<body>

    <header>
        <h1>Mentor Me</h1>
    </header>

    <div class="login" id="login-section">
        <h2>Login</h2>
        <div class="form-group">
            <label for="userId">User ID:</label>
            <input type="text" id="userId" />
        </div>
        <div class="form-group password-wrapper">
            <label for="password">Password:</label>
            <input type="password" id="password" />
            <span id="toggle-password" class="toggle-password" title="Show/Hide password"></span>
        </div>
        <button id="login-btn" onclick="login()">Login</button>
        <p id="login-error" style="color: red;"></p>
    </div>

    <div class="container hidden" id="main-app-container">
        <div class="sidebar">
            <h3>Logged in as:</h3>
            <div id="logged-in-user"></div>
            <button onclick="showSetupSection()" style="margin-bottom: 1rem; width: 100%;">New Session</button>
            <h4>Previous Sessions</h4>
            <ul id="past-sessions" title="Click to load session"></ul>
        </div>

        <div class="main-content-area" id="dynamic-content-area">

            <div class="setup" id="setup-section">
                <h2>Set Learning Preferences</h2>
                <div class="form-group">
                    <label>Skills:</label>
                    <div id="skills-selection-container" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;">
                        <span class="skill-tag predefined" data-skill="Python">Python</span>
                        <span class="skill-tag predefined" data-skill="Machine Learning">Machine Learning</span>
                        <span class="skill-tag predefined" data-skill="Data Science">Data Science</span>
                        <span class="skill-tag predefined" data-skill="AI">AI</span>
                        <span class="skill-tag predefined" data-skill="Others" id="others-skill-tag">Others</span>
                    </div>
                    <div id="custom-skill-input-container" class="hidden" style="display: flex; gap: 5px;">
                        <input type="text" id="custom-skill-input" placeholder="Type custom skill" style="flex: 1;"/>
                        <button type="button" onclick="addCustomSkill()">Add</button>
                    </div>
                    <div id="selected-skills-display" style="border: 1px solid #ccc; padding: 5px; min-height: 40px; border-radius: 5px; background-color: #fff; display: flex; flex-wrap: wrap; gap: 5px; align-items: center; margin-top: 10px;">
                        <span id="no-skills-selected" style="color: #999;">Click skills above to add</span>
                    </div>
                    <input type="hidden" id="selected-skills-hidden-input" name="selected_skills" value="" />
                </div>
                <div class="form-group">
                    <label for="difficulty">Difficulty:</label>
                    <select id="difficulty">
                        <option value="Beginner">Beginner</option>
                        <option value="Intermediate">Intermediate</option>
                        <option value="Advanced">Advanced</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="Choose_Your_Persona">Choose Your Persona:</label>
                    <select id="role">
                        <option value="Techno_Functional">Techno Functional</option>
                        <option value="Executive">Executive</option>
                        <option value="Technical">Technical</option>
                    </select>
                </div>
                <button onclick="startSession()">Start Session</button>
            </div>

            <div class="chat-area hidden" id="chat-messages-area">
                <div class="messages" id="chat-messages"></div>
                <div id="suggestion-buttons-container"></div>
                <div id="typing-indicator" class="hidden">Mentor is typing...</div>
                <div class="input-box">
                    <textarea id="user-input" placeholder="Ask your mentor..." rows="1"></textarea>
                    <button id="send-btn" onclick="sendMessage()">Send</button>
                </div>
            </div>

        </div>
    </div>

    <div class="footer">
        Powered by HCL 2025
    </div>

    <script>
        let chatHistory = [];
        let userId = "";
        let currentChatTitle = null;
        let currentTopic = null;
        let typingTimeout;
        const loginBtn = document.getElementById('login-btn');
        const sendBtn = document.getElementById('send-btn');
        const typingIndicator = document.getElementById('typing-indicator');
        const mainAppContainer = document.getElementById('main-app-container');
        const setupSection = document.getElementById('setup-section');
        const chatMessagesArea = document.getElementById('chat-messages-area');
        const chatMessagesDiv = document.getElementById('chat-messages');
        const skillsSelectionContainer = document.getElementById('skills-selection-container');
        const othersSkillTag = document.getElementById('others-skill-tag');
        const customSkillInputContainer = document.getElementById('custom-skill-input-container');
        const customSkillInput = document.getElementById('custom-skill-input');
        const selectedSkillsDisplay = document.getElementById('selected-skills-display');
        const noSkillsSelectedSpan = document.getElementById('no-skills-selected');
        const selectedSkillsHiddenInput = document.getElementById('selected-skills-hidden-input');
        let currentSelectedSkills = new Set();
        const API_BASE_URL = 'http://127.0.0.1:8086';

        document.getElementById('toggle-password').addEventListener('click', () => {
            const pwdInput = document.getElementById('password');
            if (pwdInput.type === 'password') {
                pwdInput.type = 'text';
                document.getElementById('toggle-password').textContent = 'üôà';
            } else {
                pwdInput.type = 'password';
                document.getElementById('toggle-password').textContent = 'üëÅÔ∏è';
            }
        });

        document.getElementById('user-input').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        document.getElementById('user-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        skillsSelectionContainer.addEventListener('click', (event) => {
            const target = event.target;
            if (target.classList.contains('skill-tag') && target.dataset.skill) {
                const skill = target.dataset.skill;
                if (skill === "Others") {
                    if (customSkillInputContainer.classList.contains('hidden')) {
                        customSkillInputContainer.classList.remove('hidden');
                        target.classList.add('selected');
                        if (!currentSelectedSkills.has("Others")) {
                            currentSelectedSkills.add("Others");
                            updateSelectedSkillsDisplay();
                        }
                        customSkillInput.focus();
                    } else {
                        customSkillInputContainer.classList.add('hidden');
                        target.classList.remove('selected');
                        currentSelectedSkills.delete("Others");
                        updateSelectedSkillsDisplay();
                    }
                } else {
                    if (currentSelectedSkills.has(skill)) {
                        currentSelectedSkills.delete(skill);
                        target.classList.remove('selected');
                    } else {
                        currentSelectedSkills.add(skill);
                        target.classList.add('selected');
                    }
                    updateSelectedSkillsDisplay();
                }
            }
        });

        function addCustomSkill() {
            const skill = customSkillInput.value.trim();
            if (skill && !currentSelectedSkills.has(skill)) {
                currentSelectedSkills.add(skill);
                updateSelectedSkillsDisplay();
                customSkillInput.value = "";
                customSkillInput.focus();
            } else if (currentSelectedSkills.has(skill)) {
                alert(`"${skill}" is already added.`);
            }
        }

        function removeSkill(skillToRemove) {
            currentSelectedSkills.delete(skillToRemove);
            if (skillToRemove === "Others") {
                othersSkillTag.classList.remove('selected');
                customSkillInputContainer.classList.add('hidden');
            }
            document.querySelectorAll('.skill-tag.predefined').forEach(tag => {
                if (tag.dataset.skill === skillToRemove) {
                    tag.classList.remove('selected');
                }
            });
            updateSelectedSkillsDisplay();
        }

        function updateSelectedSkillsDisplay() {
            selectedSkillsDisplay.innerHTML = '';
            if (currentSelectedSkills.size === 0) {
                selectedSkillsDisplay.appendChild(noSkillsSelectedSpan);
                noSkillsSelectedSpan.classList.remove('hidden');
            } else {
                noSkillsSelectedSpan.classList.add('hidden');
                currentSelectedSkills.forEach(skill => {
                    const skillItem = document.createElement('span');
                    skillItem.className = 'selected-skill-item';
                    skillItem.textContent = skill;
                    const removeButton = document.createElement('button');
                    removeButton.className = 'remove-skill';
                    removeButton.textContent = 'x';
                    removeButton.onclick = () => removeSkill(skill);
                    skillItem.appendChild(removeButton);
                    selectedSkillsDisplay.appendChild(skillItem);
                });
            }
            selectedSkillsHiddenInput.value = JSON.stringify(Array.from(currentSelectedSkills));
        }

        document.addEventListener('DOMContentLoaded', updateSelectedSkillsDisplay);

        async function login() {
            userId = document.getElementById("userId").value.trim();
            const password = document.getElementById("password").value;
            const errorElem = document.getElementById("login-error");
            errorElem.textContent = "";
            if (!userId || !password) {
                errorElem.textContent = "Please enter User ID and Password.";
                return;
            }
            loginBtn.disabled = true;
            loginBtn.textContent = "Logging in...";
            try {
                const res = await fetch(`${API_BASE_URL}/login`, {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({user_id: userId, password})
                });
                if (res.ok) {
                    document.getElementById("login-section").classList.add("hidden");
                    mainAppContainer.classList.remove("hidden");
                    showSetupSection();
                    document.getElementById("logged-in-user").textContent = userId;
                    const pref = localStorage.getItem(`prefs_${userId}`);
                    if (pref) {
                        try {
                            const parsed = JSON.parse(pref);
                            currentSelectedSkills = new Set(parsed.skills || []);
                            updateSelectedSkillsDisplay();
                            document.querySelectorAll('.skill-tag.predefined').forEach(tag => {
                                if (currentSelectedSkills.has(tag.dataset.skill)) {
                                    tag.classList.add('selected');
                                } else {
                                    tag.classList.remove('selected');
                                }
                            });
                            const hasNonPredefinedSkill = parsed.skills.some(s => !['Python', 'Machine Learning', 'Data Science', 'AI'].includes(s));
                            if (currentSelectedSkills.has("Others") || hasNonPredefinedSkill) {
                                othersSkillTag.classList.add('selected');
                                customSkillInputContainer.classList.remove('hidden');
                            } else {
                                othersSkillTag.classList.remove('selected');
                                customSkillInputContainer.classList.add('hidden');
                            }
                            if(parsed.difficulty) {
                                document.getElementById("difficulty").value = parsed.difficulty;
                            }
                            if(parsed.role) {
                                document.getElementById("role").value = parsed.role;
                            }
                        } catch { /* ignore parse errors */ }
                    }
                    await fetchChats();
                } else {
                    errorElem.textContent = "Login failed. Check credentials.";
                }
            } catch(e) {
                errorElem.textContent = "Error connecting to server.";
                console.error("Login error:", e);
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = "Login";
            }
        }

        function showSetupSection() {
            setupSection.classList.remove("hidden");
            chatMessagesArea.classList.add("hidden");
            chatHistory = [];
            currentChatTitle = null;
            renderMessages();
            currentSelectedSkills.clear();
            updateSelectedSkillsDisplay();
            document.querySelectorAll('.skill-tag.predefined').forEach(tag => tag.classList.remove('selected'));
            customSkillInputContainer.classList.add('hidden');
            customSkillInput.value = "";
        }

        async function fetchChats() {
            try {
                const res = await fetch(`${API_BASE_URL}/get_chats?user_id=${encodeURIComponent(userId)}`);
                if (!res.ok) throw new Error("Failed to fetch chats. Status: " + res.status);
                const data = await res.json();
                const list = document.getElementById("past-sessions");
                list.innerHTML = "";
                if (!data.chats || data.chats.length === 0) {
                    const li = document.createElement("li");
                    li.textContent = "No previous sessions";
                    li.style.fontStyle = "italic";
                    li.style.color = "#666";
                    list.appendChild(li);
                    return;
                }
                // Show most recent first
                data.chats.sort((a, b) => {
                    const dateA = new Date(a.created_at || a[2] || 0);
                    const dateB = new Date(b.created_at || b[2] || 0);
                    return dateB - dateA;
                });
                data.chats.forEach(chat => {
                    const chatId = chat.id || chat[0];
                    const chatTitle = chat.title || chat[1];
                    const chatCreatedAt = chat.created_at || chat[2];

                    const li = document.createElement("li");
                    li.title = chatTitle;
                    li.onclick = () => loadChat(chatTitle);

                    const titleDiv = document.createElement("div");
                    titleDiv.className = "session-title";
                    // Show a more readable title (replace underscores with spaces, remove timestamp/uuid)
                    titleDiv.textContent = chatTitle.replace(/_\d{8,}_\w{4}$/, '').replace(/_/g, ' ');

                    const metaDiv = document.createElement("div");
                    metaDiv.className = "session-meta";
                    const dt = chatCreatedAt ? new Date(chatCreatedAt) : null;
                    metaDiv.textContent = dt ? dt.toLocaleString() : "No Date";

                    const snippetDiv = document.createElement("div");
                    snippetDiv.className = "session-snippet";
                    snippetDiv.textContent = ""; // We'll fetch the preview below

                    // Fetch the first message for this chat for preview
                    fetch(`${API_BASE_URL}/get_chat_messages?user_id=${encodeURIComponent(userId)}&title=${encodeURIComponent(chatTitle)}`)
                        .then(res => res.json())
                        .then(data => {
                            if (data.messages && data.messages.length > 0) {
                                // Find the first assistant message
                                const firstAssistant = data.messages.find(m => m.role === "assistant");
                                if (firstAssistant) {
                                    snippetDiv.textContent = firstAssistant.content.split('\n')[0].slice(0, 60) + "...";
                                }
                            }
                        });

                    li.appendChild(titleDiv);
                    li.appendChild(metaDiv);
                    li.appendChild(snippetDiv);
                    list.appendChild(li);
                });
            } catch (e) {
                console.error("Error fetching chats:", e);
                const list = document.getElementById("past-sessions");
                list.innerHTML = '<li style="color: red; font-style: italic;">Error loading sessions. Please check server.</li>';
            }
        }

        async function loadChat(title) {
            try {
                const res = await fetch(`${API_BASE_URL}/get_chat_messages?user_id=${encodeURIComponent(userId)}&title=${encodeURIComponent(title)}`);
                if (!res.ok) throw new Error("Failed to load chat messages. Status: " + res.status);
                const data = await res.json();
                chatHistory = data.messages || [];
                chatHistory.forEach(msg => {
                    msg.isIntro = false;
                    msg.isInitialIntro = false;
                    if (typeof msg.timestamp === 'string') {
                        msg.timestamp = parseFloat(msg.timestamp);
                    }
                });
                currentChatTitle = title;
                renderMessages();
                setupSection.classList.add("hidden");
                chatMessagesArea.classList.remove("hidden");
            } catch (e) {
                console.error("Error loading chat:", e);
                alert("Failed to load chat: " + title + ". See console for details.");
            }
        }

        async function startSession() {
            const skills = Array.from(currentSelectedSkills);
            const difficulty = document.getElementById("difficulty").value;
            const role = document.getElementById("role").value;
            if (skills.length === 0) {
                alert("Please select at least one skill.");
                return;
            }
            try {
                sendBtn.disabled = true;
                sendBtn.textContent = "Starting...";
                const res = await fetch(`${API_BASE_URL}/start_session`, {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({ user_id: userId, skills, difficulty, role })
                });
                if (!res.ok) throw new Error("Failed to start session. Status: " + res.status);
                const data = await res.json();
                localStorage.setItem(`prefs_${userId}`, JSON.stringify({ skills, difficulty, role }));
                setupSection.classList.add("hidden");
                chatMessagesArea.classList.remove("hidden");
                currentChatTitle = data.title;
                const introMessage = {
                    role: "assistant",
                    content: data.intro_and_topics,
                    timestamp: Date.now() / 1000,
                    isIntro: false,
                    isInitialIntro: true
                };
                chatHistory = [introMessage];
                displayMessage(introMessage);
                if (data.topics && data.topics.length > 0) {
                    fetchAndShowTopicPrompts(data.topics[0], userId);
                }
                await fetchChats();
            } catch (e) {
                console.error("Error starting session:", e);
                alert("Failed to start session: " + e.message + ". Check console for details.");
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = "Send";
            }
        }

        function renderMessages() {
            chatMessagesDiv.innerHTML = '';
            chatHistory.forEach(msg => {
                displayMessage(msg);
            });
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
        }

        function displayMessage(messageObj) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', messageObj.role);
            if (messageObj.role === 'assistant') {
                messageDiv.classList.add('mentor-icon');
            }
            const contentSpan = document.createElement('span');
            contentSpan.textContent = messageObj.content;
            messageDiv.appendChild(contentSpan);
            const timeSpan = document.createElement('time');
            const date = messageObj.timestamp ? new Date(messageObj.timestamp * 1000) : new Date();
            timeSpan.textContent = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            messageDiv.appendChild(timeSpan);
            chatMessagesDiv.appendChild(messageDiv);
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
        }

        async function sendMessage() {
            const userInput = document.getElementById('user-input');
            const messageText = userInput.value.trim();
            if (messageText === '') return;
            if (!userId) {
                alert("Please login first.");
                return;
            }
            if (!currentChatTitle) {
                alert("Please start a new session or load a previous one first.");
                return;
            }
            const userMessageObject = {
                role: "user",
                content: messageText,
                timestamp: Date.now() / 1000
            };
            displayMessage(userMessageObject);
            chatHistory.push(userMessageObject);
            userInput.value = '';
            userInput.style.height = 'auto';
            sendBtn.disabled = true;
            typingIndicator.classList.remove('hidden');
            let container = document.getElementById('suggestion-buttons-container');
            if (container) container.style.display = 'none';
            try {
                const response = await fetch(`${API_BASE_URL}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        chat_title: currentChatTitle,
                        chat_history: chatHistory
                    })
                });
                const data = await response.json();
                if (response.ok) {
                    const mentorResponse = data.reply;
                    const mentorMessageObject = {
                        role: "assistant",
                        content: mentorResponse,
                        timestamp: Date.now() / 1000,
                        isIntro: false,
                        isInitialIntro: false
                    };
                    displayMessage(mentorMessageObject);
                    chatHistory.push(mentorMessageObject);
                    await fetchChats();
                } else {
                    let errorMessage = "Unknown error.";
                    if (response.status === 422 && data && data.detail) {
                        errorMessage = Array.isArray(data.detail) ?
                                       data.detail.map(err => `${err.loc.join('.')}: ${err.msg}`).join('; ') :
                                       data.detail;
                    } else if (data && data.detail) {
                        errorMessage = data.detail;
                    } else if (data && data.message) {
                        errorMessage = data.message;
                    } else {
                        errorMessage = `Server responded with status ${response.status}.`;
                    }
                    displayMessage({ role: 'assistant', content: `Error: ${errorMessage}`, timestamp: Date.now() / 1000 });
                }
            } catch (error) {
                console.error('Error sending message:', error);
                displayMessage({ role: 'assistant', content: 'Failed to get a response from the mentor. Please try again.', timestamp: Date.now() / 1000 });
            } finally {
                sendBtn.disabled = false;
                typingIndicator.classList.add('hidden');
            }
        }

        async function fetchAndShowTopicPrompts(topic, userId) {
            const res = await fetch(`${API_BASE_URL}/get_topic_prompts`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ topic: topic, user_id: userId })
            });
            const data = await res.json();
            showPromptButtons(data.prompts);
        }

        function showPromptButtons(prompts) {
            let container = document.getElementById('suggestion-buttons-container');
            container.innerHTML = '';
            prompts.forEach(prompt => {
                const btn = document.createElement('button');
                btn.textContent = prompt;
                btn.className = 'suggestion-btn';
                btn.onclick = () => {
                    document.getElementById('user-input').value = prompt;
                    sendMessage();
                    container.style.display = 'none';
                };
                container.appendChild(btn);
            });
            container.style.display = prompts.length > 0 ? 'flex' : 'none';
        }

        async function playMentorAudio(text, buttonElement) {
            buttonElement.disabled = true;
            buttonElement.textContent = '...';
            try {
                const encodedText = encodeURIComponent(text);
                const audioRequestUrl = `${API_BASE_URL}/text_to_speech_direct?text=${encodedText}`;
                const res = await fetch(audioRequestUrl, { method: "GET" });
                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`Failed to get audio: ${res.status} - ${errorText}`);
                }
                const audioBlob = await res.blob();
                if (audioBlob.size === 0) {
                    throw new Error("Received empty audio file from server.");
                }
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                audio.onended = () => {
                    buttonElement.disabled = false;
                    buttonElement.textContent = 'üîä';
                    URL.revokeObjectURL(audioUrl);
                };
                audio.onerror = (e) => {
                    console.error("Audio playback error event:", e);
                    buttonElement.disabled = false;
                    buttonElement.textContent = 'üîä';
                    alert("Failed to play audio. Check console for details.");
                    URL.revokeObjectURL(audioUrl);
                };
                await audio.play().catch(playError => {
                    console.error("audio.play() Promise rejected (likely autoplay policy):", playError);
                    alert("Audio playback might be blocked by your browser's autoplay policy. Please try again or check browser settings.");
                    buttonElement.disabled = false;
                    buttonElement.textContent = 'üîä';
                    URL.revokeObjectURL(audioUrl);
                });
            } catch (error) {
                console.error("Error in playMentorAudio catch block:", error);
                alert("Could not play audio: " + error.message);
                buttonElement.disabled = false;
                buttonElement.textContent = 'üîä';
            }
        }
    </script>
</body>
</html>'